# 迭代节点快速参考（中文版）

## 节点类型
```
iteration
```

## 数据结构
```json
{
  "iterator_selector": ["<节点ID>", "<变量名>"],
  "output_selector": ["<节点ID>", "<变量名>"],
  "start_node_id": "<子流程起始节点ID>"
}
```

## 参数说明

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `iterator_selector` | 数组[字符串, 字符串] | ✓ | 要遍历的数组变量路径 `[节点ID, 变量名]` |
| `output_selector` | 数组[字符串, 字符串] | ✓ | 输出结果的变量路径 `[节点ID, 变量名]` |
| `start_node_id` | 字符串 | ✓ | 子流程的起始节点ID |

## 特殊变量

在迭代子流程中可用：

| 变量 | 格式 | 说明 |
|------|------|------|
| 当前元素 | `{{#<起始节点ID>.item#}}` | 当前迭代的数组元素值 |
| 当前索引 | `{{#<起始节点ID>.index#}}` | 当前迭代的索引（从0开始） |

## 输出

迭代完成后，`output_selector` 指定的变量将包含一个数组，数组中的每个元素对应一次迭代的输出结果。

访问格式：`{{#<输出节点ID>.<输出变量名>#}}`

## 示例

### 最小示例
```json
{
  "id": "iteration_1",
  "node_type": "iteration",
  "data": {
    "iterator_selector": ["extractor_1", "items"],
    "output_selector": ["llm_2", "results"],
    "start_node_id": "llm_1"
  }
}
```

### 完整流程示例
```
开始 → 参数提取器 → 迭代 → 回答
                      ↓
                LLM_1 → LLM_2
                (子流程)
```

## 执行流程

1. 从 `iterator_selector` 获取数组
2. 对数组中每个元素：
   - 设置 `#起始节点ID.item#` = 当前元素
   - 设置 `#起始节点ID.index#` = 当前索引
   - 执行子流程（从 `start_node_id` 开始）
   - 收集 `output_selector` 节点的输出
3. 将所有输出聚合到数组
4. 继续执行后续节点

## 常见错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `iterator_selector must have exactly 2 elements` | 数组长度不是2 | 确保格式为 `["节点ID", "变量名"]` |
| `Iterator variable 'xxx' not found or not an array` | 变量不存在或不是数组 | 检查变量路径和类型 |
| `Sub-flow execution failed` | 子流程执行出错 | 检查子流程节点配置 |

## 注意事项

- ✓ 迭代数组必须是字符串数组或对象数组
- ✓ 子流程必须到达 `output_selector` 指定的节点
- ✓ 避免过大的数组导致性能问题
- ✓ 子流程中的任何错误都会导致整个迭代失败

## 实际应用场景

### 场景1：批量处理检查项
```
用户输入 → 提取检查项 → 迭代处理 → 汇总结果
                          ↓
                    分析每个检查项
```

### 场景2：多文档处理
```
文档列表 → 迭代 → 最终报告
            ↓
      处理单个文档
```

### 场景3：数据转换
```
原始数据 → 迭代 → 转换后的数据
            ↓
      转换单条记录
```

## 变量命名建议

- 迭代器变量：使用复数形式，如 `items`、`documents`、`records`
- 输出变量：使用描述性名称，如 `processed_items`、`analysis_results`
- 子流程节点：使用清晰的前缀，如 `process_`、`analyze_`

## 性能优化建议

1. **控制数组大小**：避免一次处理过多元素
2. **简化子流程**：保持子流程逻辑简单高效
3. **合理使用缓存**：对重复计算使用缓存
4. **监控执行时间**：设置合理的超时限制

## 调试技巧

1. **检查迭代数组**：确认数组内容和格式正确
2. **验证子流程**：单独测试子流程逻辑
3. **查看中间结果**：在子流程中添加日志节点
4. **逐步测试**：从小数组开始测试，逐步增加规模

## 相关文档

- [完整使用指南](./iteration_node_guide.md)
- [参数提取器节点](./parameter_extractor_quick_reference_zh.md)
- [LLM节点文本变量](./llm_node_text_variable.md)
- [执行引擎实现](./execution_engine_implementation.md)

## 版本信息

- **实现版本**: v0.1.0
- **最后更新**: 2024
- **状态**: 稳定

## 技术支持

如遇到问题，请检查：
1. 节点配置是否正确
2. 变量路径是否存在
3. 数组类型是否匹配
4. 子流程是否能正常执行

更多详细信息，请参阅[完整使用指南](./iteration_node_guide.md)。
